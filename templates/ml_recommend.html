{% extends "base.html" %}
{% block title %}Smart Recommendations ‚Äî GreenPath{% endblock %}

{% block extra_head %}
<style>
  .ml-hero {
    background: linear-gradient(135deg, var(--forest) 0%, var(--forest-mid) 50%, var(--forest-light) 100%);
    padding: 3.5rem 2rem; color: white; position: relative; overflow: hidden;
  }
  .ml-hero::before {
    content: '';
    position: absolute; inset: 0;
    background-image:
      radial-gradient(circle at 15% 85%, rgba(78,154,111,0.25) 0%, transparent 40%),
      radial-gradient(circle at 85% 15%, rgba(126,200,69,0.15) 0%, transparent 40%);
    pointer-events: none;
  }
  .ml-hero-inner { max-width: 1200px; margin: 0 auto; position: relative; z-index: 1; }
  .ml-badge {
    display: inline-flex; align-items: center; gap: 0.5rem;
    background: rgba(78,154,111,0.25); border: 1px solid rgba(126,200,69,0.4);
    color: var(--lime); font-size: 0.78rem; font-weight: 600;
    letter-spacing: 0.1em; text-transform: uppercase;
    padding: 0.35rem 1rem; border-radius: 20px; margin-bottom: 1.25rem;
  }
  .ml-hero h1 {
    font-family: 'Playfair Display', serif; font-size: clamp(2rem, 5vw, 3rem);
    font-weight: 700; color: white; line-height: 1.2; margin-bottom: 0.75rem;
  }
  .ml-hero h1 em { color: var(--lime); font-style: italic; }
  .ml-hero p { color: rgba(255,255,255,0.65); max-width: 540px; font-size: 1rem; }

  /* Cluster pills */
  .cluster-row {
    display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 2rem;
  }
  .cluster-pill {
    padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.78rem; font-weight: 600;
    display: flex; align-items: center; gap: 0.4rem;
  }

  /* LAYOUT */
  .ml-layout {
    max-width: 1200px; margin: 0 auto;
    display: grid; grid-template-columns: 300px 1fr;
    gap: 2rem; padding: 2rem;
    align-items: start;
  }
  @media(max-width: 900px) { .ml-layout { grid-template-columns: 1fr; } }

  /* FILTER PANEL */
  .ml-filters {
    background: white; border-radius: 16px;
    border: 1px solid var(--border); padding: 1.5rem;
    position: sticky; top: 80px;
  }
  .ml-filter-title {
    font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700;
    color: var(--forest); margin-bottom: 0.25rem;
  }
  .ml-filter-sub { font-size: 0.78rem; color: var(--text-muted); margin-bottom: 1.5rem; }
  .filter-sec { margin-bottom: 1.5rem; }
  .filter-sec-title {
    font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.75rem;
    padding-bottom: 0.4rem; border-bottom: 1px solid var(--border);
  }
  .slider-wrap { margin-bottom: 0.75rem; }
  .slider-label { display: flex; justify-content: space-between; font-size: 0.82rem; margin-bottom: 4px; }
  .slider-label span { color: var(--text-muted); }
  .slider-val { font-weight: 700; color: var(--moss); }
  input[type=range] {
    width: 100%; accent-color: var(--moss);
    cursor: pointer; height: 4px;
  }
  .health-pref-btns { display: flex; gap: 0.4rem; }
  .pref-btn {
    flex: 1; padding: 0.45rem 0; border-radius: 7px; font-size: 0.78rem;
    font-weight: 600; border: 1.5px solid var(--border); background: white;
    cursor: pointer; font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.15s;
    color: var(--text-muted);
  }
  .pref-btn.active { background: var(--moss); color: white; border-color: var(--moss); }
  .filter-check {
    display: flex; align-items: center; gap: 0.6rem;
    padding: 0.35rem 0; cursor: pointer; font-size: 0.875rem;
  }
  .filter-check input { accent-color: var(--moss); width: 16px; height: 16px; cursor: pointer; }

  /* RESULTS */
  .results-bar {
    display: flex; justify-content: space-between; align-items: center;
    flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1.5rem;
  }
  .results-bar h2 {
    font-family: 'Playfair Display', serif; font-size: 1.2rem; color: var(--forest);
  }
  .ml-tag {
    display: inline-flex; align-items: center; gap: 0.4rem;
    background: #EDE9FE; color: #6D28D9; font-size: 0.75rem; font-weight: 600;
    padding: 0.3rem 0.75rem; border-radius: 20px;
  }

  .products-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 1rem;
  }
  .ml-card {
    background: white; border-radius: 14px; border: 1px solid var(--border);
    padding: 1.25rem; display: flex; flex-direction: column; gap: 0.8rem;
    transition: transform 0.2s, box-shadow 0.2s; position: relative;
  }
  .ml-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
  .ml-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
    background: linear-gradient(90deg, #6366F1, var(--lime)); border-radius: 14px 14px 0 0;
  }

  .sim-bar-wrap { margin-top: 0.25rem; }
  .sim-bar-label {
    display: flex; justify-content: space-between;
    font-size: 0.7rem; color: var(--text-muted); margin-bottom: 3px;
  }
  .sim-bar-bg { background: var(--border); border-radius: 4px; height: 5px; overflow: hidden; }
  .sim-bar-fill {
    height: 100%; border-radius: 4px;
    background: linear-gradient(90deg, #6366F1, var(--lime));
    transition: width 0.5s ease;
  }

  .product-brand { font-size: 0.7rem; font-weight: 700; color: var(--moss); text-transform: uppercase; letter-spacing: 0.06em; }
  .product-name {
    font-family: 'Playfair Display', serif; font-size: 0.95rem; font-weight: 700;
    color: var(--forest); line-height: 1.3;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  }
  .grade-pair { display: flex; gap: 0.4rem; }
  .grade-mini { display: flex; align-items: center; gap: 0.3rem; font-size: 0.68rem; color: var(--text-muted); }
  .grade-mini .grade { width: 26px; height: 26px; font-size: 0.7rem; }

  .nutr-mini { display: flex; gap: 0.4rem; flex-wrap: wrap; }
  .nutr-pill { font-size: 0.68rem; font-weight: 600; padding: 0.12rem 0.4rem; border-radius: 4px; background: var(--dew); color: var(--text-muted); }
  .nutr-pill strong { color: var(--text); }

  .badges-row { display: flex; gap: 0.3rem; flex-wrap: wrap; }
  .card-footer {
    margin-top: auto; padding-top: 0.75rem; border-top: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
  }
  .view-btn { font-size: 0.8rem; font-weight: 600; color: var(--moss); text-decoration: none; }
  .view-btn:hover { color: var(--moss); }
  .cluster-tag {
    font-size: 0.68rem; font-weight: 700; padding: 0.2rem 0.5rem; border-radius: 4px;
  }

  /* HOW IT WORKS INFO */
  .algo-info {
    background: #EDE9FE; border: 1px solid #C4B5FD; border-radius: 12px;
    padding: 1rem 1.25rem; margin-bottom: 1.5rem;
    font-size: 0.82rem; color: #4C1D95; line-height: 1.6;
  }
  .algo-info strong { color: var(--forest-mid); }
</style>
{% endblock %}

{% block content %}
<div class="ml-hero">
  <div class="ml-hero-inner">
    <div class="ml-badge">ü§ñ ML-Powered</div>
    <h1>Smart <em>Recommendations</em></h1>
    <p>Tell us your preferences ‚Äî our content-based ML model finds your ideal products using cosine similarity across nutrition, ingredients & health features.</p>

    <!-- Cluster summary pills -->
    <div class="cluster-row">
      {% for c in cluster_summary %}
      <div class="cluster-pill" style="background:{{ c.bg }}; color:{{ c.color }};">
        <span>{{ c.label }}</span>
        <span style="opacity:0.6;">{{ c.count }} products</span>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<div class="ml-layout">
  <!-- FILTER PANEL -->
  <aside class="ml-filters">
    <div class="ml-filter-title">üéØ Your Preferences</div>
    <div class="ml-filter-sub">Adjust to get personalised ML recommendations</div>

    <form method="GET" action="/ml-recommend" id="mlForm">

      <!-- Health preference -->
      <div class="filter-sec">
        <div class="filter-sec-title">Health Goal</div>
        <div class="health-pref-btns">
          <button type="button" class="pref-btn {% if prefs.health_preference == 'healthy' %}active{% endif %}"
                  onclick="setHealthPref('healthy', this)">Healthy</button>
          <button type="button" class="pref-btn {% if prefs.health_preference == 'moderate' %}active{% endif %}"
                  onclick="setHealthPref('moderate', this)">Moderate</button>
          <button type="button" class="pref-btn {% if prefs.health_preference == 'any' %}active{% endif %}"
                  onclick="setHealthPref('any', this)">Any</button>
        </div>
        <input type="hidden" name="health_preference" id="healthPrefInput" value="{{ prefs.health_preference }}">
      </div>

      <!-- Sliders -->
      <div class="filter-sec">
        <div class="filter-sec-title">Nutrition Limits (per 100g)</div>
        <div class="slider-wrap">
          <div class="slider-label">
            <span>Max Sugar</span>
            <span class="slider-val" id="sugarVal">{{ prefs.max_sugar|int }}g</span>
          </div>
          <input type="range" name="max_sugar" min="0" max="50" value="{{ prefs.max_sugar|int }}"
                 oninput="document.getElementById('sugarVal').textContent=this.value+'g'">
        </div>
        <div class="slider-wrap">
          <div class="slider-label">
            <span>Max Fat</span>
            <span class="slider-val" id="fatVal">{{ prefs.max_fat|int }}g</span>
          </div>
          <input type="range" name="max_fat" min="0" max="35" value="{{ prefs.max_fat|int }}"
                 oninput="document.getElementById('fatVal').textContent=this.value+'g'">
        </div>
        <div class="slider-wrap">
          <div class="slider-label">
            <span>Min Protein</span>
            <span class="slider-val" id="protVal">{{ prefs.min_protein|int }}g</span>
          </div>
          <input type="range" name="min_protein" min="0" max="15" value="{{ prefs.min_protein|int }}"
                 oninput="document.getElementById('protVal').textContent=this.value+'g'">
        </div>
      </div>

      <!-- Dietary -->
      <div class="filter-sec">
        <div class="filter-sec-title">Dietary</div>
        <label class="filter-check">
          <input type="checkbox" name="vegan" value="1" {% if prefs.vegan %}checked{% endif %}> üå± Vegan
        </label>
        <label class="filter-check">
          <input type="checkbox" name="organic" value="1" {% if prefs.organic %}checked{% endif %}> üåø Organic
        </label>
      </div>

      <!-- Avoid -->
      <div class="filter-sec">
        <div class="filter-sec-title">Avoid</div>
        <label class="filter-check">
          <input type="checkbox" name="no_trans_fat" value="1" {% if prefs.no_trans_fat %}checked{% endif %}> No Trans Fat
        </label>
        <label class="filter-check">
          <input type="checkbox" name="no_artificial_colors" value="1" {% if prefs.no_artificial_colors %}checked{% endif %}> No Artificial Colors
        </label>
        <label class="filter-check">
          <input type="checkbox" name="no_preservatives" value="1" {% if prefs.no_preservatives %}checked{% endif %}> No Preservatives
        </label>
      </div>

      <button type="submit" class="btn btn-primary" style="width:100%; justify-content:center;">
        ü§ñ Get Recommendations
      </button>
      <a href="/ml-recommend" style="display:block; text-align:center; margin-top:0.75rem; font-size:0.78rem; color: var(--text-muted); text-decoration:underline; cursor:pointer;">Reset</a>
    </form>
  </aside>

  <!-- RESULTS -->
  <div>
    <div class="algo-info">
      <strong>Algorithm:</strong> Content-Based Filtering with Cosine Similarity ‚Äî
      products are matched using a <strong>116-dimensional feature vector</strong> combining
      normalised nutrition values (60% weight) and TF-IDF ingredient text embeddings (40% weight).
      K-Means (k=5) clusters products into health tiers.
    </div>

    <div class="results-bar">
      <h2>{{ total }} Recommendations</h2>
      <span class="ml-tag">ü§ñ Cosine Similarity + KMeans</span>
    </div>

    {% if products %}
    <div class="products-grid">
      {% for p in products %}
      <div class="ml-card" style="animation: fadeUp 0.3s ease {{ [loop.index0 * 0.04, 0.5]|min }}s both;">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:0.75rem;">
          <div style="flex:1; min-width:0;">
            <div class="product-brand">{{ p.brand }}</div>
            <div class="product-name">{{ p.name }}</div>
          </div>
          <div class="grade-pair">
            <div class="grade-mini">
              <div class="grade grade-{{ p.health_grade }}">{{ p.health_grade }}</div>
            </div>
          </div>
        </div>

        <!-- Similarity score bar -->
        <div class="sim-bar-wrap">
          <div class="sim-bar-label">
            <span>Match score</span>
            <span style="color:#6366F1; font-weight:700;">{{ p.similarity }}%</span>
          </div>
          <div class="sim-bar-bg">
            <div class="sim-bar-fill" style="width:{{ p.similarity }}%;"></div>
          </div>
        </div>

        {% if p.energy or p.protein %}
        <div class="nutr-mini">
          {% if p.energy %}<span class="nutr-pill">‚ö° <strong>{{ p.energy|int }}</strong> kcal</span>{% endif %}
          {% if p.protein %}<span class="nutr-pill">üí™ <strong>{{ p.protein }}g</strong></span>{% endif %}
          {% if p.sugars %}<span class="nutr-pill">üç¨ <strong>{{ p.sugars }}g</strong> sugar</span>{% endif %}
        </div>
        {% endif %}

        {% if p.badges %}
        <div class="badges-row">
          {% for b in p.badges[:3] %}<span class="badge badge-{{ b.color }}">{{ b.label }}</span>{% endfor %}
        </div>
        {% endif %}

        <div class="card-footer">
          <a href="/product/{{ p.id }}" class="view-btn">Details ‚Üí</a>
          <span class="cluster-tag" style="background:{{ {'Healthiest':'#DCFCE7','Healthy':'#D1FAE5','Moderate':'#FEF9C3','Indulgent':'#FED7AA','Most Indulgent':'#FEE2E2'}.get(p.cluster_label,'#F3F4F6') }}; color:{{ {'Healthiest':'#166534','Healthy':'#065F46','Moderate':'#92400E','Indulgent':'#9A3412','Most Indulgent':'#991B1B'}.get(p.cluster_label,'#6B7280') }};">
            {{ p.cluster_label }}
          </span>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div style="text-align:center; padding:4rem 2rem; background:white; border-radius:16px; border:1px solid var(--border);">
      <div style="font-size:3rem; margin-bottom:1rem;">üîç</div>
      <h3 style="font-family: 'Playfair Display', serif; color: var(--forest); margin-bottom:0.5rem;">No matches found</h3>
      <p style="color: var(--text-muted);">Try relaxing your filters.</p>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  function setHealthPref(val, btn) {
    document.getElementById('healthPrefInput').value = val;
    document.querySelectorAll('.pref-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  // Auto-submit on checkbox change
  document.querySelectorAll('input[type=checkbox]').forEach(cb => {
    cb.addEventListener('change', () => document.getElementById('mlForm').submit());
  });
</script>
{% endblock %}
